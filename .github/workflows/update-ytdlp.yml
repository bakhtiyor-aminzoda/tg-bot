name: Auto-update yt-dlp

on:
  # Ð•Ð¶ÐµÐ½ÐµÐ´ÐµÐ»ÑŒÐ½Ð¾Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ð¾ ÑÑ€ÐµÐ´Ð° Ð² 3 ÑƒÑ‚Ñ€Ð° UTC
  schedule:
    - cron: '0 3 * * 3'
  # Ð’Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚ÑŒ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ
  workflow_dispatch:

jobs:
  update-ytdlp:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ðŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ðŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install yt-dlp packaging
      
      - name: ðŸ” Check current yt-dlp version
        run: |
          echo "Current version:"
          yt-dlp --version
      
      - name: ðŸ”„ Update yt-dlp
        run: |
          pip install --upgrade yt-dlp
          echo "New version:"
          yt-dlp --version
      
      - name: ðŸ“ Update requirements.txt
        run: |
          pip freeze | grep -i yt-dlp >> /tmp/new_version.txt || true
          # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ requirements.txt Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐµÑÐ»Ð¸ yt-dlp Ð²ÐµÑ€ÑÐ¸Ñ Ð¸Ð·Ð¼ÐµÐ½Ð¸Ð»Ð°ÑÑŒ
          if grep -q "yt-dlp" requirements.txt; then
            # Ð—Ð°Ð¼ÐµÐ½ÑÐµÐ¼ ÑÑ‚Ð°Ñ€ÑƒÑŽ Ð²ÐµÑ€ÑÐ¸ÑŽ Ð½Ð° Ð½Ð¾Ð²ÑƒÑŽ
            pip show yt-dlp | grep Version | awk '{print "yt-dlp>=" $2}' > /tmp/ytdlp_line.txt
            sed -i '/^yt-dlp/d' requirements.txt
            cat /tmp/ytdlp_line.txt >> requirements.txt
          fi
      
      - name: ðŸ§ª Test basic functionality
        run: |
          yt-dlp --version
          yt-dlp --help | head -n 5
      
      - name: ðŸ“¤ Create Pull Request
        uses: peter-evans/create-pull-request@v4
        with:
          commit-message: 'chore: auto-update yt-dlp to latest version'
          title: 'chore: auto-update yt-dlp'
          body: |
            This is an automated pull request to update yt-dlp to the latest version.
            
            **Changes:**
            - Updated yt-dlp to latest version from PyPI
            - Tested basic functionality
            
            Please review and merge if tests pass.
          branch: chore/update-ytdlp-${{ github.run_id }}
          delete-branch: true
          labels: 'automation'
